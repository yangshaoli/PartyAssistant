{% extends 'login_base.html' %}
{% block title %} 受邀联系人列表 {% endblock %}

{% block script %}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery-1.6.4.min.js"></script>
<script>
    $(document).ready(function(){
        ajaxGetClients('apply');//进入页面时获得[已报名]列表 
        
        $('a[id^="tab_"]').bind('click', function(){
            var applystatus = this.id.split('_')[1];
            ajaxGetClients(applystatus);
        })
    })

function clientAction(id, applystatus){
    var answer = '<a href="{% url change_status %}?party_client_id='+id+'&applystatus=apply&next='+applystatus+'"><button>参加</button></a>';
    var reject = '<a href="{% url change_status %}?party_client_id='+id+'&applystatus=reject&next='+applystatus+'"><button>不参加</button></a>';
    switch (applystatus) {
        case 'apply' : 
            var action = answer + reject;
            return action; 
        case 'noanswer' : 
            var action = answer;
            return action;
        case 'reject' :
            var action = reject;
            return action;
    }
}

function ajaxGetClients(applystatus){
    $('.accordion_content table tbody').children().remove();
    
    $.ajax({
        type : 'GET',
        url: '/clients/invite_list_ajax/'+{{party.id}}+'/?apply='+applystatus,
        statusCode : {
        200: function(response){
            clients = JSON.parse(response);
            for (i in clients){
                var new_status = clients[i].is_new?'<img src="/static/images/icon_new.png" width="30" height="14" alt="new" />':'';
                var action = clientAction(clients[i].id, applystatus)//判断applystatus，显示相应按钮
                row = "<tr><td>"+new_status+"</td><th>"+clients[i].name+"</th><td>"+clients[i].address+"</td><td>"+action+"</td></tr>"
                $('.accordion_content table tbody').append(row);    
            }
            
            //修改[再次邀请]的url
            $('.accordion_toggle img').parent().attr('href', applystatus);
        },
        500: function(){ alert('没有获取到用户列表')}
        }
    });
}

</script>
{% endblock %}

{% block content %}
<script>
 
  function refesh(){
   document.execCommand('Refresh')
  }
</script>
</head>
{% csrf_token %}
<div id="content">
  <div class="grid_a">
   <h2 class="title">谁来了</h2>
   <div class="apply_details">
    <p>{{party.start_time|date:"y年m月d日"|default:"日期待定"}}{{ party.start_time|date:"H:i"|default:"时间待定" }}</p>
    <p>{{party.address|default:"地点待定"}} <span class="minor">参加活动</span></p>
    <p>{{party.description}}</p>
   </div>
   <div class="accordionview">
    <div class="accordion_panel">
     <h2 class="accordion_toggle accordion_toggle_active"> <a id="tab_apply">来凑热闹的 <strong>{% if is_new %}<i class="icon_new">{% endif %}</i>({{party_clients.apply.client_count}}人)</strong></a> <a id="tab_noanswer">还在犹豫的<strong> ({{party_clients.noanswer.client_count}}人)</strong></a> <a href="#" id="tab_reject">就是不来的 <strong>({{party_clients.reject.client_count}}人)</strong></a> <a href='{% url email_invite party.id %}?apply={{ applystatus }}'><img src="/static/images/btn_please.png" width="62" height="23" alt="please" class="btn_please" /></a></h2>
     <div class="accordion_content">
      <table width="100%" border="0" cellspacing="0" class="table">
      <thead>
       <tr>
        <th width="7%" scope="col">&nbsp;</th>
        <th width="23%" scope="col">姓名</th>
        <th width="52%" scope="col">联系方式</th>
        <th width="18%" scope="col" class="ta_r">&nbsp;</th>
       </tr>
       <tbody>
{% for party_client in party_clients_list %}
       <tr>
        <th>{% if party_client.isnew %}{% endif %}</th>
        <th>{{ party_client.client.name }}</th>
        <td>
        </td>
        <td>
{% if applystatus == 'all' or applystatus == 'noanswer' %}
 <a href="{% url change_status %}?party_client_id={{ party_client.id }}&applystatus=apply&next={{ applystatus }}">参加</a>
    &nbsp;&nbsp;&nbsp;
    <a href="{% url change_status %}?party_client_id={{ party_client.id }}&applystatus=reject&next={{ applystatus }}">不参加</a>
{% endif %}
{% if applystatus == 'apply' %}
    <a href='{% url change_status %}?party_client_id={{ party_client.id }}&applystatus=reject&next={{ applystatus }}'>不参加</a>
{% endif %}
{% if applystatus == 'reject' %}
    <a href='{% url change_status %}?party_client_id={{ party_client.id }}&applystatus=apply&next={{ applystatus }}'>参加</a>
{% endif %}
        </td>
       </tr>
{% endfor %}
       </tbody>
      </table>
      <a href='{% url list_party %}'><button>返回</button></a>
     </div>
    </div>
   </div>
  </div>
 </div>
{% endblock %}
 
